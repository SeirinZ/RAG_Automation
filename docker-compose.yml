version: '3.8'

services:
  # ===========================================
  # RAG API Server (Main Application)
  # ===========================================
  rag-api:
    build: .
    container_name: rag-api
    ports:
      - "8000:8000"
    volumes:
      - ./chroma_db:/app/chroma_db
      - ./processed_pdfs:/app/processed_pdfs
      - ./pdf_uploads:/app/pdf_uploads
    environment:
      - OLLAMA_HOST=host.docker.internal:11434
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  # ===========================================
  # Open WebUI (Chat Interface)
  # ===========================================
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "3000:8080"
    volumes:
      # Use local folder instead of Docker volume (for data migration)
      - ./docker_data/open-webui:/app/backend/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      # Connect to RAG API for retrieval-augmented responses
      - OPENAI_API_BASE_URL=http://rag-api:8000/v1
      - OPENAI_API_KEY=not-needed
    restart: unless-stopped

  # ===========================================
  # n8n Workflow Automation
  # ===========================================
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n
    ports:
      - "5678:5678"
    volumes:
      # Use local folder instead of Docker volume (for data migration)
      - ./n8n_data:/home/node/.n8n
      - ./pdf_uploads:/files
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=changeme
    restart: unless-stopped
